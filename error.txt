Run python -m pytest tests/integration --cov=src --cov-report=xml --cov-report=html
============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.2, pluggy-1.6.0
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/runner/work/Medical-Text-Classifier/Medical-Text-Classifier
configfile: pytest.ini
plugins: anyio-4.11.0, html-4.1.1, timeout-2.4.0, asyncio-1.2.0, Faker-37.11.0, benchmark-5.1.0, cov-7.0.0, json-report-1.5.0, env-1.2.0, xdist-3.8.0, mock-3.15.1, metadata-3.1.1, postgresql-7.0.2
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 17 items

tests/integration/test_api.py .........F...FF..                          [100%]

=================================== FAILURES ===================================
_____________ TestPredictionEndpoint.test_predict_whitespace_text ______________

self = <tests.integration.test_api.TestPredictionEndpoint object at 0x7fd51bf3eb90>
integration_client = <starlette.testclient.TestClient object at 0x7fd52cb82350>

    @pytest.mark.integration
    def test_predict_whitespace_text(self, integration_client):
        """Test prediction with whitespace-only text."""
        response = integration_client.post(
            "/predict",
            json={"text": "   \n\t  "}
        )
    
        # Whitespace-only text should be treated as empty and return an error
>       assert response.status_code == 500
E       assert 400 == 500
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/test_api.py:183: AssertionError
---------------------------- Captured stderr setup -----------------------------
2025-10-23 03:31:13,399 - src.api.main - INFO - Starting Medical Text Classification API...
2025-10-23 03:31:13,399 - src.api.inference - INFO - Model not found, using rule-based classification as fallback
2025-10-23 03:31:13,400 - src.api.main - INFO - Model loading completed
2025-10-23 03:31:13,400 - src.api.main - WARNING - Failed to start Prometheus server: [Errno 98] Address already in use
------------------------------ Captured log setup ------------------------------
INFO     src.api.main:main.py:60 Starting Medical Text Classification API...
INFO     src.api.inference:inference.py:132 Model not found, using rule-based classification as fallback
INFO     src.api.main:main.py:66 Model loading completed
WARNING  src.api.main:main.py:76 Failed to start Prometheus server: [Errno 98] Address already in use
----------------------------- Captured stderr call -----------------------------
2025-10-23 03:31:13,402 - src.api.middleware - INFO - Request: {'method': 'POST', 'path': '/predict', 'query_params': '', 'client_ip': 'testclient', 'user_agent': 'testclient', 'timestamp': '2025-10-23T03:31:13.401965+00:00', 'headers': {'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip, deflate', 'connection': 'keep-alive', 'user-agent': 'testclient', 'content-length': '20', 'content-type': 'application/json'}}
2025-10-23 03:31:13,404 - src.api.middleware - INFO - Response: status=400, duration=0.003s
2025-10-23 03:31:13,406 - httpx - INFO - HTTP Request: POST http://testserver/predict "HTTP/1.1 400 Bad Request"
------------------------------ Captured log call -------------------------------
INFO     src.api.middleware:middleware.py:170 Request: {'method': 'POST', 'path': '/predict', 'query_params': '', 'client_ip': 'testclient', 'user_agent': 'testclient', 'timestamp': '2025-10-23T03:31:13.401965+00:00', 'headers': {'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip, deflate', 'connection': 'keep-alive', 'user-agent': 'testclient', 'content-length': '20', 'content-type': 'application/json'}}
INFO     src.api.middleware:middleware.py:179 Response: status=400, duration=0.003s
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/predict "HTTP/1.1 400 Bad Request"
--------------------------- Captured stderr teardown ---------------------------
2025-10-23 03:31:13,485 - src.api.main - INFO - Shutting down Medical Text Classification API...
---------------------------- Captured log teardown -----------------------------
INFO     src.api.main:main.py:81 Shutting down Medical Text Classification API...
__________________ TestCORSHeaders.test_cors_headers_present ___________________

self = <tests.integration.test_api.TestCORSHeaders object at 0x7fd51bf3fa90>
client = <starlette.testclient.TestClient object at 0x7fd51c0d60d0>

    @pytest.mark.integration
    def test_cors_headers_present(self, client):
        """Test that CORS headers are present in responses."""
        # Make a request with Origin header to trigger CORS
        response = client.get(
            "/health",
            headers={"Origin": "http://localhost:3001"}
        )
    
        assert response.status_code == 200
    
        # Check for CORS headers
        headers = response.headers
        # CORS headers might be lowercase in test client
        header_keys = [key.lower() for key in headers.keys()]
>       assert any("access-control-allow-origin" in key for key in header_keys)
E       assert False
E        +  where False = any(<generator object TestCORSHeaders.test_cors_headers_present.<locals>.<genexpr> at 0x7fd51ac653c0>)

tests/integration/test_api.py:281: AssertionError
---------------------------- Captured stderr setup -----------------------------
2025-10-23 03:31:13,523 - src.api.main - INFO - Starting Medical Text Classification API...
2025-10-23 03:31:13,524 - src.api.main - INFO - Model loading completed
2025-10-23 03:31:13,524 - src.api.main - WARNING - Failed to start Prometheus server: [Errno 98] Address already in use
------------------------------ Captured log setup ------------------------------
INFO     src.api.main:main.py:60 Starting Medical Text Classification API...
INFO     src.api.main:main.py:66 Model loading completed
WARNING  src.api.main:main.py:76 Failed to start Prometheus server: [Errno 98] Address already in use
----------------------------- Captured stderr call -----------------------------
2025-10-23 03:31:13,526 - src.api.middleware - INFO - Request: {'method': 'GET', 'path': '/health', 'query_params': '', 'client_ip': 'testclient', 'user_agent': 'testclient', 'timestamp': '2025-10-23T03:31:13.526153+00:00', 'headers': {'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip, deflate', 'connection': 'keep-alive', 'user-agent': 'testclient', 'origin': 'http://localhost:3001'}}
2025-10-23 03:31:13,527 - src.api.middleware - INFO - Response: status=200, duration=0.002s
2025-10-23 03:31:13,529 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     src.api.middleware:middleware.py:170 Request: {'method': 'GET', 'path': '/health', 'query_params': '', 'client_ip': 'testclient', 'user_agent': 'testclient', 'timestamp': '2025-10-23T03:31:13.526153+00:00', 'headers': {'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip, deflate', 'connection': 'keep-alive', 'user-agent': 'testclient', 'origin': 'http://localhost:3001'}}
INFO     src.api.middleware:middleware.py:179 Response: status=200, duration=0.002s
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
--------------------------- Captured stderr teardown ---------------------------
2025-10-23 03:31:13,537 - src.api.main - INFO - Shutting down Medical Text Classification API...
---------------------------- Captured log teardown -----------------------------
INFO     src.api.main:main.py:81 Shutting down Medical Text Classification API...
_____________________ TestCORSHeaders.test_options_request _____________________

self = <tests.integration.test_api.TestCORSHeaders object at 0x7fd51c0d55d0>
client = <starlette.testclient.TestClient object at 0x7fd51bf4c2d0>

    @pytest.mark.integration
    def test_options_request(self, client):
        """Test OPTIONS request for CORS preflight."""
        response = client.options(
            "/predict",
            headers={
                "Origin": "http://localhost:3001",
                "Access-Control-Request-Method": "POST",
                "Access-Control-Request-Headers": "Content-Type"
            }
        )
    
        # Should handle OPTIONS request
>       assert response.status_code in [200, 204]
E       assert 400 in [200, 204]
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/integration/test_api.py:296: AssertionError
---------------------------- Captured stderr setup -----------------------------
2025-10-23 03:31:13,541 - src.api.main - INFO - Starting Medical Text Classification API...
2025-10-23 03:31:13,541 - src.api.main - INFO - Model loading completed
2025-10-23 03:31:13,542 - src.api.main - WARNING - Failed to start Prometheus server: [Errno 98] Address already in use
------------------------------ Captured log setup ------------------------------
INFO     src.api.main:main.py:60 Starting Medical Text Classification API...
INFO     src.api.main:main.py:66 Model loading completed
WARNING  src.api.main:main.py:76 Failed to start Prometheus server: [Errno 98] Address already in use
----------------------------- Captured stderr call -----------------------------
2025-10-23 03:31:13,544 - httpx - INFO - HTTP Request: OPTIONS http://testserver/predict "HTTP/1.1 400 Bad Request"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: OPTIONS http://testserver/predict "HTTP/1.1 400 Bad Request"
--------------------------- Captured stderr teardown ---------------------------
2025-10-23 03:31:13,551 - src.api.main - INFO - Shutting down Medical Text Classification API...
---------------------------- Captured log teardown -----------------------------
INFO     src.api.main:main.py:81 Shutting down Medical Text Classification API...
=============================== warnings summary ===============================
../../../../../opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/passlib/utils/__init__.py:854
  /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

tests/integration/test_api.py::TestPredictionEndpoint::test_predict_invalid_json
  /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/httpx/_models.py:408: DeprecationWarning: Use 'content=<...>' to upload raw bytes/text content.
    headers, stream = encode_request(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.11.13-final-0 _______________

Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/integration/test_api.py::TestPredictionEndpoint::test_predict_whitespace_text - assert 400 == 500
 +  where 400 = <Response [400 Bad Request]>.status_code
FAILED tests/integration/test_api.py::TestCORSHeaders::test_cors_headers_present - assert False
 +  where False = any(<generator object TestCORSHeaders.test_cors_headers_present.<locals>.<genexpr> at 0x7fd51ac653c0>)
FAILED tests/integration/test_api.py::TestCORSHeaders::test_options_request - assert 400 in [200, 204]
 +  where 400 = <Response [400 Bad Request]>.status_code
=================== 3 failed, 14 passed, 2 warnings in 0.74s ===================
Error: Process completed with exit code 1.